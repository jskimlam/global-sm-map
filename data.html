<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global SM Companies Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .map-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar {
            width: 350px;
            background: white;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        
        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
        }
        
        #header h1 {
            font-size: 22px;
            font-weight: 600;
            margin: 0;
        }
        
        #map {
            flex: 1;
            width: 100%;
        }
        
        .stats-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .stats-section h3 {
            font-size: 14px;
            color: #667eea;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            background: #e9ecef;
            transform: translateX(-5px);
        }
        
        .stat-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #333;
        }
        
        .stat-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        
        .stat-number {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }
        
        /* ÌïòÏúÑ Íµ≠Í∞Ä Î™©Î°ù */
        .sub-countries {
            margin-left: 26px;
            margin-top: 5px;
            display: none;
        }
        
        .sub-countries.active {
            display: block;
        }
        
        .sub-country-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 6px;
            background: #fff;
            border: 1px solid #e9ecef;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sub-country-item:hover {
            background: #f8f9fa;
            border-color: #667eea;
            transform: translateX(-3px);
        }
        
        .expand-icon {
            margin-left: 5px;
            font-size: 10px;
            transition: transform 0.3s ease;
        }
        
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        .legend-section {
            padding: 20px;
        }
        
        .legend-section h3 {
            font-size: 14px;
            color: #667eea;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 13px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .legend-item:hover {
            background: #f8f9fa;
        }
        
        .legend-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .size-legend {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .size-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .size-circle {
            border-radius: 50%;
            background: #667eea;
            margin-right: 10px;
        }
        
        /* ÎßàÏª§ Ïä§ÌÉÄÏùº */
        .custom-marker {
            background: transparent;
            border: none;
        }
        
        .custom-marker svg {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            transition: all 0.3s ease;
        }
        
        .custom-marker:hover svg {
            transform: scale(1.3);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .pulse-marker {
            animation: pulse 2s ease-in-out infinite;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .leaflet-popup-content {
            margin: 15px;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .company-name {
            font-weight: bold;
            color: #667eea;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .label-marker {
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="map-section">
            <div id="header">
                <h1>üåç Global SM Production Companies</h1>
            </div>
            <div id="map"></div>
        </div>
        
        <div class="sidebar">
            <div class="stats-section">
                <h3>üìä Statistics</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Companies</span>
                    <span class="stat-number" id="total-count">0</span>
                </div>
                <div class="stat-item" onclick="showMaintenanceMarkers('current')">
                    <span class="stat-label">‚ö´ Current Maintenance</span>
                    <span class="stat-number" id="current-maintenance-count">0</span>
                </div>
                <div class="stat-item" onclick="showMaintenanceMarkers('future')">
                    <span class="stat-label">üîµ Future Maintenance</span>
                    <span class="stat-number" id="future-maintenance-count">0</span>
                </div>
            </div>
            
            <div class="stats-section">
                <h3>üåç Regions</h3>
                <div class="stat-item" onclick="toggleSubCountries('asia')">
                    <span class="stat-label">
                        <span class="stat-color" style="background-color: #FF6B6B;"></span>
                        Asia
                        <span class="expand-icon" id="asia-icon">‚ñº</span>
                    </span>
                    <span class="stat-number" id="asia-count">0</span>
                </div>
                <div class="sub-countries" id="asia-sub">
                    <div class="sub-country-item" onclick="flyToCountry('china')">
                        üá®üá≥ China (<span id="china-count">0</span>)
                    </div>
                    <div class="sub-country-item" onclick="flyToCountry('japan')">
                        üáØüáµ Japan (<span id="japan-count">0</span>)
                    </div>
                    <div class="sub-country-item" onclick="flyToCountry('korea')">
                        üá∞üá∑ Korea (<span id="korea-count">0</span>)
                    </div>
                    <div class="sub-country-item" onclick="flyToCountry('taiwan')">
                        üáπüáº Taiwan (<span id="taiwan-count">0</span>)
                    </div>
                    <div class="sub-country-item" onclick="flyToCountry('sea')">
                        üåè SEA (<span id="sea-count">0</span>)
                    </div>
                </div>
                
                <div class="stat-item" onclick="flyToRegion('americas')">
                    <span class="stat-label">
                        <span class="stat-color" style="background-color: #95E1D3;"></span>
                        Americas
                    </span>
                    <span class="stat-number" id="americas-count">0</span>
                </div>
                <div class="stat-item" onclick="flyToRegion('europe')">
                    <span class="stat-label">
                        <span class="stat-color" style="background-color: #4ECDC4;"></span>
                        Europe
                    </span>
                    <span class="stat-number" id="europe-count">0</span>
                </div>
                <div class="stat-item" onclick="flyToRegion('middleeast')">
                    <span class="stat-label">
                        <span class="stat-color" style="background-color: #FFB84D;"></span>
                        Middle East
                    </span>
                    <span class="stat-number" id="me-count">0</span>
                </div>
                <div class="stat-item" onclick="flyToRegion('russia')">
                    <span class="stat-label">
                        <span class="stat-color" style="background-color: #C7CEEA;"></span>
                        Russia
                    </span>
                    <span class="stat-number" id="russia-count">0</span>
                </div>
            </div>
            
            <div class="legend-section">
                <h3>üìç Status</h3>
                <div class="legend-item" onclick="showMaintenanceMarkers('current')">
                    <div class="legend-marker" style="background-color: black;"></div>
                    <span>Current Maintenance (Feb)</span>
                </div>
                <div class="legend-item" onclick="showMaintenanceMarkers('future')">
                    <div class="legend-marker" style="background-color: #4169E1; clip-path: polygon(50% 0%, 0% 100%, 100% 100%);"></div>
                    <span>Future Maintenance (Mar+)</span>
                </div>
                
                <div class="size-legend">
                    <h3 style="margin-bottom: 10px;">üìè Capacity</h3>
                    <div class="size-item">
                        <div class="size-circle" style="width: 10px; height: 10px;"></div>
                        <span>0-100 kt</span>
                    </div>
                    <div class="size-item">
                        <div class="size-circle" style="width: 14px; height: 14px;"></div>
                        <span>100-300 kt</span>
                    </div>
                    <div class="size-item">
                        <div class="size-circle" style="width: 18px; height: 18px;"></div>
                        <span>300-500 kt</span>
                    </div>
                    <div class="size-item">
                        <div class="size-circle" style="width: 24px; height: 24px;"></div>
                        <span>500-700 kt</span>
                    </div>
                    <div class="size-item">
                        <div class="size-circle" style="width: 30px; height: 30px;"></div>
                        <span>700+ kt</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let allMarkers = [];
        let clusters = [];
        
        // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        fetch('data.json')
            .then(response => response.json())
            .then(data => {
                clusters = data.clusters;
                initMap();
            })
            .catch(error => {
                console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                alert('ÏßÄÎèÑ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. data.json ÌååÏùºÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
            });
        
        function initMap() {
            // ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
            map = L.map('map');
            
            // ÏßÄÏó≠Î≥Ñ ÏÉâÏÉÅ
            function getRegionColor(country) {
                const regionMap = {
                    'CHINA (MAINLAND)': '#FF6B6B',
                    'KOREA, SOUTH': '#FF6B6B',
                    'JAPAN': '#FF6B6B',
                    'TAIWAN': '#FF6B6B',
                    'SINGAPORE': '#FF6B6B',
                    'INDONESIA': '#FF6B6B',
                    'THAILAND': '#FF6B6B',
                    'USA': '#95E1D3',
                    'CANADA': '#95E1D3',
                    'BRAZIL': '#95E1D3',
                    'BELGIUM': '#4ECDC4',
                    'FRANCE': '#4ECDC4',
                    'GERMANY': '#4ECDC4',
                    'ITALY': '#4ECDC4',
                    'NETHERLANDS': '#4ECDC4',
                    'SPAIN': '#4ECDC4',
                    'POLAND': '#4ECDC4',
                    'CZECH REPUBLIC': '#4ECDC4',
                    'SAUDI ARABIA': '#FFB84D',
                    'KUWAIT': '#FFB84D',
                    'IRAN': '#FFB84D',
                    'RUSSIA': '#C7CEEA'
                };
                return regionMap[country] || '#95a5a6';
            }
            
            // ÌÉÄÏùº Î†àÏù¥Ïñ¥
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors ¬© CARTO'
            }).addTo(map);
            
            let totalCompanies = 0;
            let currentMaintenanceCount = 0;
            let futureMaintenanceCount = 0;
            let asiaCnt = 0, americasCnt = 0, europeCnt = 0, meCnt = 0, russiaCnt = 0;
            let chinaCnt = 0, japanCnt = 0, koreaCnt = 0, taiwanCnt = 0, seaCnt = 0;
            
            // ÎßàÏª§ Ï∂îÍ∞Ä
            clusters.forEach(cluster => {
                const companies = cluster.companies;
                totalCompanies += companies.length;
                
                companies.forEach(company => {
                    // ÏßÄÏó≠Î≥Ñ Ïπ¥Ïö¥Ìä∏
                    if (company.country === 'CHINA (MAINLAND)') { asiaCnt++; chinaCnt++; }
                    else if (company.country === 'JAPAN') { asiaCnt++; japanCnt++; }
                    else if (company.country === 'KOREA, SOUTH') { asiaCnt++; koreaCnt++; }
                    else if (company.country === 'TAIWAN') { asiaCnt++; taiwanCnt++; }
                    else if (['SINGAPORE', 'INDONESIA', 'THAILAND'].includes(company.country)) { asiaCnt++; seaCnt++; }
                    else if (['USA', 'CANADA', 'BRAZIL'].includes(company.country)) americasCnt++;
                    else if (['BELGIUM', 'FRANCE', 'GERMANY', 'ITALY', 'NETHERLANDS', 'SPAIN', 'POLAND', 'CZECH REPUBLIC'].includes(company.country)) europeCnt++;
                    else if (['SAUDI ARABIA', 'KUWAIT', 'IRAN'].includes(company.country)) meCnt++;
                    else if (company.country === 'RUSSIA') russiaCnt++;
                    
                    // Ï†ïÍ∏∞Î≥¥Ïàò Ïπ¥Ïö¥Ìä∏
                    if (company.is_current_maintenance) currentMaintenanceCount++;
                    if (company.has_future_maintenance) futureMaintenanceCount++;
                });
                
                let color = getRegionColor(cluster.country);
                let shape = 'pin';
                
                // ÌòÑÏû¨ Ï†ïÍ∏∞Î≥¥Ïàò Ï§ë
                const isCurrentMaintenance = companies.some(c => c.is_current_maintenance);
                if (isCurrentMaintenance) {
                    color = 'black';
                }
                
                // ÎØ∏Îûò Ï†ïÍ∏∞Î≥¥Ïàò ÏòàÏ†ï
                const isFutureMaintenance = companies.some(c => c.has_future_maintenance);
                if (isFutureMaintenance) {
                    shape = 'triangle';
                    color = '#4169E1';
                }
                
                const avgCapacity = companies.reduce((sum, c) => {
                    const cap = c.capacity === 'N/A' ? 0 : parseInt(c.capacity);
                    return sum + cap;
                }, 0) / companies.length;
                
                let markerSize = 18;
                if (avgCapacity < 100) markerSize = 10;
                else if (avgCapacity < 300) markerSize = 14;
                else if (avgCapacity < 500) markerSize = 18;
                else if (avgCapacity < 700) markerSize = 24;
                else markerSize = 30;
                
                const pinHeight = markerSize * 1.3;
                
                let iconHtml = '';
                if (shape === 'triangle') {
                    iconHtml = `<svg width="${markerSize}" height="${pinHeight}" viewBox="0 0 100 120">
                        <polygon points="50,10 10,110 90,110" fill="${color}" stroke="white" stroke-width="3"/>
                    </svg>`;
                } else {
                    iconHtml = `<svg width="${markerSize}" height="${pinHeight}" viewBox="0 0 100 120">
                        <path d="M50,10 C30,10 15,25 15,45 C15,65 50,110 50,110 C50,110 85,65 85,45 C85,25 70,10 50,10 Z" 
                              fill="${color}" stroke="white" stroke-width="3"/>
                    </svg>`;
                }
                
                const customIcon = L.divIcon({
                    className: 'custom-marker' + (isFutureMaintenance ? ' pulse-marker' : ''),
                    html: iconHtml,
                    iconSize: [markerSize, pinHeight],
                    iconAnchor: [markerSize/2, pinHeight],
                    popupAnchor: [0, -pinHeight]
                });
                
                const marker = L.marker([cluster.lat, cluster.lng], { icon: customIcon });
                marker.clusterData = cluster;
                marker.isCurrentMaintenance = isCurrentMaintenance;
                marker.isFutureMaintenance = isFutureMaintenance;
                
                let popupContent = `<div style="max-width: 300px;">`;
                if (companies.length === 1) {
                    const c = companies[0];
                    popupContent += `
                        <div class="company-name">${c.company}</div>
                        <div><strong>Location:</strong> ${c.location}, ${c.country}</div>
                        <div><strong>Capacity:</strong> ${c.capacity} kt/year</div>
                        <div><strong>Maintenance:</strong> ${c.maintenance}</div>
                    `;
                } else {
                    popupContent += `<div class="company-name">${cluster.location} (${companies.length} companies)</div>`;
                    companies.forEach(c => {
                        popupContent += `
                            <div style="border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px;">
                                <div style="font-weight: 500;">${c.company}</div>
                                <div style="font-size: 12px; color: #666;">
                                    Capacity: ${c.capacity} kt | Maintenance: ${c.maintenance}
                                </div>
                            </div>
                        `;
                    });
                }
                popupContent += `</div>`;
                
                marker.bindPopup(popupContent);
                
                let labelMarker;
                marker.on('click', function(e) {
                    if (labelMarker) {
                        map.removeLayer(labelMarker);
                    }
                    
                    const labelIcon = L.divIcon({
                        className: 'label-marker',
                        html: cluster.location,
                        iconSize: null,
                        iconAnchor: [0, pinHeight + 10]
                    });
                    
                    labelMarker = L.marker([cluster.lat, cluster.lng], { icon: labelIcon, interactive: false }).addTo(map);
                });
                
                marker.on('popupclose', function() {
                    if (labelMarker) {
                        map.removeLayer(labelMarker);
                        labelMarker = null;
                    }
                });
                
                marker.addTo(map);
                allMarkers.push(marker);
            });
            
            // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('total-count').textContent = totalCompanies;
            document.getElementById('current-maintenance-count').textContent = currentMaintenanceCount;
            document.getElementById('future-maintenance-count').textContent = futureMaintenanceCount;
            document.getElementById('asia-count').textContent = asiaCnt;
            document.getElementById('americas-count').textContent = americasCnt;
            document.getElementById('europe-count').textContent = europeCnt;
            document.getElementById('me-count').textContent = meCnt;
            document.getElementById('russia-count').textContent = russiaCnt;
            document.getElementById('china-count').textContent = chinaCnt;
            document.getElementById('japan-count').textContent = japanCnt;
            document.getElementById('korea-count').textContent = koreaCnt;
            document.getElementById('taiwan-count').textContent = taiwanCnt;
            document.getElementById('sea-count').textContent = seaCnt;
            
            // Î™®Îì† ÎßàÏª§Í∞Ä Î≥¥Ïù¥ÎèÑÎ°ù Fit Bounds
            const bounds = L.latLngBounds(clusters.map(c => [c.lat, c.lng]));
            map.fitBounds(bounds, { padding: [50, 50] });
            
            console.log(`Total: ${totalCompanies} companies, ${clusters.length} markers`);
        }
        
        // ÏïÑÏãúÏïÑ ÌïòÏúÑ Íµ≠Í∞Ä ÌÜ†Í∏Ä
        function toggleSubCountries(region) {
            if (region === 'asia') {
                const subDiv = document.getElementById('asia-sub');
                const icon = document.getElementById('asia-icon');
                subDiv.classList.toggle('active');
                icon.classList.toggle('expanded');
            } else {
                flyToRegion(region);
            }
        }
        
        // ÏßÄÏó≠Î≥Ñ Ïù¥Îèô
        function flyToRegion(region) {
            const regionCenters = {
                'asia': { lat: 35, lng: 110, zoom: 4 },
                'americas': { lat: 40, lng: -95, zoom: 3 },
                'europe': { lat: 50, lng: 10, zoom: 4 },
                'middleeast': { lat: 27, lng: 50, zoom: 5 },
                'russia': { lat: 56, lng: 54, zoom: 5 }
            };
            
            const center = regionCenters[region];
            if (center) {
                map.flyTo([center.lat, center.lng], center.zoom, { duration: 1.5 });
            }
        }
        
        // Íµ≠Í∞ÄÎ≥Ñ Ïù¥Îèô (ÏïÑÏãúÏïÑ ÏÑ∏Î∂Ä)
        function flyToCountry(country) {
            const countryCenters = {
                'china': { lat: 35, lng: 115, zoom: 5 },
                'japan': { lat: 36, lng: 138, zoom: 6 },
                'korea': { lat: 36.5, lng: 127.5, zoom: 7 },
                'taiwan': { lat: 24, lng: 121, zoom: 8 },
                'sea': { lat: 5, lng: 110, zoom: 5 }
            };
            
            const center = countryCenters[country];
            if (center) {
                map.flyTo([center.lat, center.lng], center.zoom, { duration: 1.5 });
            }
        }
        
        // Ï†ïÍ∏∞Î≥¥Ïàò ÎßàÏª§ Ï∞æÏïÑÍ∞ÄÍ∏∞
        function showMaintenanceMarkers(type) {
            let targetMarkers = [];
            
            if (type === 'current') {
                targetMarkers = allMarkers.filter(m => m.isCurrentMaintenance);
            } else if (type === 'future') {
                targetMarkers = allMarkers.filter(m => m.isFutureMaintenance);
            }
            
            if (targetMarkers.length > 0) {
                const bounds = L.latLngBounds(targetMarkers.map(m => m.getLatLng()));
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 6 });
                
                // Ï≤´ Î≤àÏß∏ ÎßàÏª§ ÌåùÏóÖ Ïó¥Í∏∞
                setTimeout(() => {
                    targetMarkers[0].openPopup();
                }, 1000);
            }
        }
    </script>
</body>
</html>