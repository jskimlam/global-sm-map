<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global SM Companies Status</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f5f5f5; overflow: hidden; }
        .container { display: flex; height: 100vh; width: 100vw; position: relative; overflow: hidden; }

        /* ì§€ë„ ì˜ì—­ */
        .map-section { flex: 1; height: 100%; transition: all 0.4s ease; position: relative; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* ì‚¬ì´ë“œë°” (ì˜¤ë¥¸ìª½ ë°°ì¹˜) */
        .sidebar { 
            width: 420px; height: 100%; background: white; 
            box-shadow: -5px 0 15px rgba(0,0,0,0.1); 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000; position: relative; display: flex; flex-direction: column;
        }
        .container.collapsed .sidebar { transform: translateX(420px); }

        /* ìŠ¬ë¼ì´ë“œ í•¸ë“¤ ë²„íŠ¼ */
        #toggle-btn {
            position: absolute; left: -30px; top: 50%; transform: translateY(-50%);
            width: 30px; height: 80px; background: #667eea; color: white;
            border: none; border-radius: 12px 0 0 12px; cursor: pointer;
            z-index: 1100; font-size: 18px; display: flex; align-items: center; justify-content: center;
            box-shadow: -3px 0 10px rgba(0,0,0,0.2);
        }

        /* í—¤ë” ë° ë¸Œëœë”© */
        #header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; }
        #header h1 { font-size: 19px; font-weight: 600; margin-bottom: 2px; }
        .made-by { font-size: 13px; font-weight: bold; opacity: 0.9; margin-bottom: 12px; }
        .archive-select {
            width: 100%; padding: 10px; border-radius: 6px; border: none;
            background: rgba(255,255,255,0.2); color: white; font-weight: bold;
        }

        .content-area { flex: 1; overflow-y: auto; padding: 15px 20px; }

        /* í†µê³„ ì„¹ì…˜ */
        .stats-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .stats-section h3 { font-size: 13px; color: #667eea; margin-bottom: 12px; text-transform: uppercase; font-weight: 600; }
        
        .capacity-box { padding: 15px; border-radius: 10px; margin-bottom: 10px; background: #f8fbff; border-left: 5px solid #667eea; }
        .capacity-title { font-size: 11px; color: #667eea; font-weight: bold; margin-bottom: 5px; }
        .capacity-value { font-size: 24px; font-weight: 800; color: #333; }
        .denom-info { font-size: 11px; color: #777; margin-top: 4px; border-top: 1px dashed #ddd; padding-top: 4px; }

        /* ì§€ì—­/êµ­ê°€ ë¦¬ìŠ¤íŠ¸ */
        .region-item { margin-bottom: 6px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        .region-header { 
            padding: 10px; background: #fafafa; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; font-size: 13px; font-weight: 600;
        }
        .region-header:hover { background: #f0f5ff; }
        .country-item { 
            padding: 8px 15px 8px 30px; display: flex; justify-content: space-between; align-items: center;
            font-size: 12px; cursor: pointer; border-top: 1px solid #fcfcfc;
        }
        .country-item:hover { color: #667eea; background: #f9f9f9; }
        .stat-badge { font-size: 10px; color: #667eea; font-weight: bold; }

        /* í•„í„° ë° ë¦¬ìŠ¤íŠ¸ */
        .filter-tabs { display: flex; gap: 5px; margin-bottom: 12px; }
        .tab-btn { flex: 1; padding: 8px; font-size: 11px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; background: #fff; font-weight: bold; }
        .tab-btn.active { background: #667eea; color: white; border-color: #667eea; }
        
        .maint-card { padding: 10px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 6px; font-size: 11px; cursor: pointer; }
        .maint-card:hover { border-color: #667eea; transform: translateX(-3px); }
        .marker-svg { filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3)); }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <div class="map-section">
            <div id="map"></div>
        </div>
        
        <div class="sidebar" id="sidebar">
            <button id="toggle-btn" onclick="toggleSidebar()">â—€</button>

            <div id="header">
                <h1>Global SM Companies Status</h1>
                <div class="made-by">Made by LAM</div>
                <select class="archive-select" onchange="switchProduct(this.value)">
                    <option value="data.json">Styrene Monomer (SM)</option>
                    <option value="data_an.json">AN (Acrylonitrile) - ì¤€ë¹„ì¤‘</option>
                    <option value="data_bd.json">Butadiene (BD) - ì¤€ë¹„ì¤‘</option>
                </select>
            </div>

            <div class="content-area">
                <div class="stats-section">
                    <h3>ğŸ“Š 2026 Global Balance</h3>
                    <div class="capacity-box" style="background: #f0f4ff; border-color: #4169e1;">
                        <div class="capacity-title" style="color: #4169e1;">Yearly Cumulative Loss Rate (2026)</div>
                        <span class="capacity-value" id="total-loss-rate" style="color: #4169e1;">0.00%</span>
                        <div class="denom-info" id="total-denom">Loss: 0 / Total Cap: 0 kt</div>
                    </div>
                    <div class="capacity-box" style="background: #fff5f5; border-color: #ff6b6b;">
                        <div class="capacity-title" style="color: #ff6b6b;">Current Loss Rate (Feb 2026)</div>
                        <span class="capacity-value" id="current-loss-rate" style="color: #ff6b6b;">0.00%</span>
                        <div class="denom-info" id="current-denom">Loss: 0 / Monthly Base: 0 kt</div>
                    </div>
                </div>

                <div class="stats-section">
                    <h3>ğŸŒ Regions & Capacity Weight</h3>
                    <div id="region-list"></div>
                </div>

                <div class="stats-section">
                    <h3>ğŸ“ Maintenance Archive</h3>
                    <div class="filter-tabs">
                        <button class="tab-btn active" id="btn-curr" onclick="setListFilter('current')">Current</button>
                        <button class="tab-btn" id="btn-futr" onclick="setListFilter('future')">Future</button>
                    </div>
                    <div id="maint-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map, clusters = [], allMarkers = [];
        let currentFilter = 'current';
        const today = new Date('2026-02-04');
        const febStart = new Date('2026-02-01'), febEnd = new Date('2026-02-28');

        function initApp() {
            map = L.map('map').setView([25, 115], 3);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            loadData('data.json');
        }

        async function loadData(file) {
            try {
                const res = await fetch(file);
                const data = await res.json();
                clusters = data.clusters;
                updateDashboard();
            } catch(e) { console.error("Load Error"); }
        }

        function updateDashboard() {
            allMarkers.forEach(m => map.removeLayer(m));
            allMarkers = [];

            let totalGlobalCap = 0, currentLossSum = 0, yearlyLossSum = 0;
            let regStats = { 'Asia': { cap: 0, countries: { 'CHINA (MAINLAND)': 0, 'KOREA, SOUTH': 0, 'JAPAN': 0, 'TAIWAN': 0, 'SEA': 0 } }, 'Americas': { cap: 0 }, 'Europe': { cap: 0 }, 'Middle East': { cap: 0 }, 'Russia': { cap: 0 } };

            const listDiv = document.getElementById('maint-list');
            listDiv.innerHTML = '';

            clusters.forEach(c => {
                let clusterCap = 0, isCurrent = false, isFuture = false;

                c.companies.forEach(comp => {
                    const cap = parseFloat(comp.capacity) || 0;
                    totalGlobalCap += cap;
                    clusterCap += cap;

                    // ì§€ì—­ ë¶„ë¥˜
                    let reg = ['USA','CANADA','BRAZIL'].includes(c.country) ? 'Americas' : ['BELGIUM','FRANCE','GERMANY','ITALY','NETHERLANDS','SPAIN','POLAND','CZECH REPUBLIC'].includes(c.country) ? 'Europe' : ['SAUDI ARABIA','KUWAIT','IRAN'].includes(c.country) ? 'Middle East' : c.country === 'RUSSIA' ? 'Russia' : 'Asia';
                    regStats[reg].cap += cap;
                    if (reg === 'Asia') {
                        if (regStats.Asia.countries[c.country] !== undefined) regStats.Asia.countries[c.country] += cap;
                        else regStats.Asia.countries['SEA'] += cap;
                    }

                    // ì •ë°€ ë¡œìŠ¤ ê³„ì‚°
                    if (comp.maint_start && comp.maint_end) {
                        const start = new Date(comp.maint_start), end = new Date(comp.maint_end);
                        // ì—°ê°„ ì˜¤ë²„ë©
                        const yrOverlap = Math.max(0, Math.min(end, new Date('2026-12-31')) - Math.max(start, new Date('2026-01-01'))) / (1000*60*60*24) + 1;
                        if(yrOverlap > 0) yearlyLossSum += (cap / 365) * yrOverlap;
                        // 2ì›” ì˜¤ë²„ë©
                        const febOverlap = Math.max(0, Math.min(end, febEnd) - Math.max(start, febStart)) / (1000*60*60*24) + 1;
                        if(febOverlap > 0) currentLossSum += (cap / 365) * febOverlap;

                        if (today >= start && today <= end) isCurrent = true;
                        else if (start > today) isFuture = true;

                        // ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
                        if ((currentFilter === 'current' && isCurrent) || (currentFilter === 'future' && isFuture)) {
                            listDiv.innerHTML += `<div class="maint-card" onclick="map.flyTo([${c.lat}, ${c.lng}], 8)"><b>${comp.company}</b><br>Cap: ${cap}kt | ${comp.maint_start} ~ ${comp.maint_end}</div>`;
                        }
                    }
                });

                // ë§ˆì»¤ í¬ê¸° ë° í˜•íƒœ (ì‚¼ê°í˜•/ì›í˜•)
                let radius = clusterCap < 100 ? 5 : clusterCap < 300 ? 9 : clusterCap < 500 ? 13 : clusterCap < 800 ? 18 : 25;
                const color = isCurrent ? "#000000" : (isFuture ? "#e67e22" : "#667eea");
                const s = radius * 2;
                const icon = L.divIcon({
                    className: 'marker-svg',
                    html: isFuture ? `<svg width="${s}" height="${s}" viewBox="0 0 100 100"><polygon points="50,10 95,90 5,90" fill="${color}" stroke="white" stroke-width="6"/></svg>` : `<svg width="${s}" height="${s}" viewBox="0 0 100 100"><circle cx="50" cy="50" r="42" fill="${color}" stroke="white" stroke-width="8"/></svg>`,
                    iconSize: [s, s], iconAnchor: [s/2, s/2]
                });
                const marker = L.marker([c.lat, c.lng], { icon }).addTo(map);
                marker.bindPopup(`<b>${c.location}, ${c.country}</b><br>Total Cap: ${clusterCap.toLocaleString()}kt`);
                allMarkers.push(marker);
            });

            // 1. ì „ì—­ ë°¸ëŸ°ìŠ¤ ì—…ë°ì´íŠ¸
            const monthlyBase = totalGlobalCap / 12;
            document.getElementById('total-loss-rate').innerText = (yearlyLossSum / totalGlobalCap * 100).toFixed(2) + '%';
            document.getElementById('total-denom').innerText = `Loss: ${Math.round(yearlyLossSum).toLocaleString()} / Total: ${Math.round(totalGlobalCap).toLocaleString()} kt`;
            document.getElementById('current-loss-rate').innerText = (currentLossSum / monthlyBase * 100).toFixed(2) + '%';
            document.getElementById('current-denom').innerText = `Loss: ${Math.round(currentLossSum).toLocaleString()} / Monthly Base: ${Math.round(monthlyBase).toLocaleString()} kt`;

            // 2. ì§€ì—­ë³„ ë¹„ì¤‘ ë¦¬ìŠ¤íŠ¸ ìƒì„±
            const regList = document.getElementById('region-list');
            regList.innerHTML = '';
            Object.keys(regStats).forEach(reg => {
                const rData = regStats[reg];
                const rPct = (rData.cap / totalGlobalCap * 100).toFixed(1);
                let html = `<div class="region-item"><div class="region-header" onclick="flyTo('${reg.toLowerCase()}')"><span>${reg}</span><span class="stat-badge">${rData.cap.toLocaleString()} kt (${rPct}%)</span></div>`;
                if (reg === 'Asia') {
                    html += `<div class="country-list">`;
                    Object.keys(rData.countries).forEach(count => {
                        const cCap = rData.countries[count];
                        const cPct = (cCap / totalGlobalCap * 100).toFixed(1);
                        const label = count === 'CHINA (MAINLAND)' ? 'ğŸ‡¨ğŸ‡³ China' : count === 'KOREA, SOUTH' ? 'ğŸ‡°ğŸ‡· Korea' : count === 'JAPAN' ? 'ğŸ‡¯ğŸ‡µ Japan' : count === 'TAIWAN' ? 'ğŸ‡¹ğŸ‡¼ Taiwan' : 'ğŸŒ SEA';
                        html += `<div class="country-item" onclick="flyTo('${count.toLowerCase().replace(' (mainland)','').replace(', south','')}')"><span>${label}</span><span class="country-pct">${cCap.toLocaleString()} kt (${cPct}%)</span></div>`;
                    });
                    html += `</div>`;
                }
                html += `</div>`;
                regList.innerHTML += html;
            });
        }

        function setListFilter(type) {
            currentFilter = type;
            document.getElementById('btn-curr').classList.toggle('active', type === 'current');
            document.getElementById('btn-futr').classList.toggle('active', type === 'future');
            updateDashboard();
        }

        function toggleSidebar() {
            const container = document.getElementById('main-container');
            container.classList.toggle('collapsed');
            document.getElementById('toggle-btn').innerText = container.classList.contains('collapsed') ? 'â—€' : 'â–¶';
            setTimeout(() => { map.invalidateSize(); }, 450);
        }

        function flyTo(loc) {
            const t = { 'asia':[[20, 110], 4], 'korea':[[36.5, 127], 7], 'china':[[35, 110], 5], 'japan':[[36, 138], 6], 'taiwan':[[23.5, 121], 7], 'sea':[[5, 110], 5], 'europe':[[50, 10], 4], 'americas':[[38, -98], 4], 'middleeast':[[25, 45], 4], 'russia':[[55, 60], 4] };
            if(t[loc]) map.flyTo(t[loc][0], t[loc][1]);
        }
        function switchProduct(val) { loadData(val); }
        window.onload = initApp;
    </script>
</body>
</html>
