<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global SM Companies Status</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .map-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar {
            width: 380px;
            background: white;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        
        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        
        #header h1 {
            font-size: 20px;
            font-weight: 600;
            margin: 0 0 5px 0;
        }
        
        #header .subtitle {
            font-size: 12px;
            opacity: 0.9;
        }
        
        #map {
            flex: 1;
            width: 100%;
        }
        
        .stats-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .stats-section h3 {
            font-size: 13px;
            color: #667eea;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 6px;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            background: #e9ecef;
            transform: translateX(-5px);
        }
        
        .stat-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #333;
        }
        
        .stat-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }
        
        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-detail {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        
        /* ÌïòÏúÑ Î™©Î°ù */
        .sub-items {
            margin-left: 22px;
            margin-top: 5px;
            display: none;
        }
        
        .sub-items.active {
            display: block;
        }
        
        .sub-item {
            padding: 7px 10px;
            margin-bottom: 4px;
            border-radius: 6px;
            background: #fff;
            border: 1px solid #e9ecef;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sub-item:hover {
            background: #f8f9fa;
            border-color: #667eea;
            transform: translateX(-3px);
        }
        
        .sub-item-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
        }
        
        .sub-item-detail {
            font-size: 10px;
            color: #666;
        }
        
        .expand-icon {
            margin-left: 5px;
            font-size: 9px;
            transition: transform 0.3s ease;
        }
        
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        /* Capacity ÌëúÏãú */
        .capacity-box {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .capacity-title {
            font-size: 11px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .capacity-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        .capacity-unit {
            font-size: 12px;
            color: #666;
            margin-left: 5px;
        }
        
        .legend-section {
            padding: 20px;
        }
        
        .legend-section h3 {
            font-size: 13px;
            color: #667eea;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .legend-item:hover {
            background: #f8f9fa;
        }
        
        .legend-marker {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .size-legend {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .size-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 11px;
        }
        
        .size-circle {
            border-radius: 50%;
            background: #667eea;
            margin-right: 8px;
        }
        
        /* ÎßàÏª§ Ïä§ÌÉÄÏùº */
        .custom-marker {
            background: transparent;
            border: none;
        }
        
        .custom-marker svg {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            transition: all 0.3s ease;
        }
        
        .custom-marker:hover svg {
            transform: scale(1.3);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .pulse-marker {
            animation: pulse 2s ease-in-out infinite;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .leaflet-popup-content {
            margin: 15px;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .company-name {
            font-weight: bold;
            color: #667eea;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .label-marker {
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="map-section">
            <div id="header">
                <h1>Global SM Companies Status</h1>
                <div class="subtitle">Made by LAM</div>
            </div>
            <div id="map"></div>
        </div>
        
        <div class="sidebar">
            <div class="stats-section">
                <h3>üìä Statistics</h3>
                <div class="stat-item" onclick="resetMapView()">
                    <span class="stat-label">Total Companies</span>
                    <span class="stat-number" id="total-count">0</span>
                </div>
                
                <div class="capacity-box">
                    <div class="capacity-title">Total Capacity</div>
                    <div>
                        <span class="capacity-value" id="total-capacity">0</span>
                        <span class="capacity-unit">kt/year</span>
                    </div>
                </div>
                
                <div class="capacity-box" style="background: #ff6b6b15;">
                    <div class="capacity-title">Current Loss Rate (Feb)</div>
                    <div>
                        <span class="capacity-value" id="current-loss-rate" style="color: #ff6b6b;">0</span>
                        <span class="capacity-unit">%</span>
                    </div>
                    <div class="stat-detail" id="current-loss-detail">Loss: 0 kt</div>
                </div>
                
                <div class="capacity-box" style="background: #4169e115;">
                    <div class="capacity-title">Total Loss Rate (2026)</div>
                    <div>
                        <span class="capacity-value" id="total-loss-rate" style="color: #4169e1;">0</span>
                        <span class="capacity-unit">%</span>
                    </div>
                    <div class="stat-detail" id="total-loss-detail">Loss: 0 kt</div>
                </div>
                
                <div class="stat-item" onclick="toggleSubItems('current')">
                    <span class="stat-label">
                        ‚ö´ Current Maintenance
                        <span class="expand-icon" id="current-icon">‚ñº</span>
                    </span>
                    <span class="stat-number" id="current-maintenance-count">0</span>
                </div>
                <div class="sub-items" id="current-sub"></div>
                
                <div class="stat-item" onclick="toggleSubItems('future')">
                    <span class="stat-label">
                        üîµ Future Maintenance
                        <span class="expand-icon" id="future-icon">‚ñº</span>
                    </span>
                    <span class="stat-number" id="future-maintenance-count">0</span>
                </div>
                <div class="sub-items" id="future-sub"></div>
            </div>
            
            <div class="stats-section">
                <h3>üåç Regions</h3>
                
                <div class="stat-item" onclick="toggleSubItems('asia')">
                    <div style="flex: 1;">
                        <div class="stat-label">
                            <span class="stat-color" style="background-color: #FF6B6B;"></span>
                            Asia
                            <span class="expand-icon" id="asia-icon">‚ñº</span>
                        </div>
                        <div class="stat-detail"><span id="asia-capacity">0 kt/year</span> (<span id="asia-pct">0%</span>)</div>
                    </div>
                    <span class="stat-number" id="asia-count">0</span>
                </div>
                <div class="sub-items" id="asia-sub">
                    <div class="sub-item" onclick="flyToCountry('china')">
                        <div class="sub-item-name">üá®üá≥ China (<span id="china-count">0</span>)</div>
                        <div class="sub-item-detail"><span id="china-capacity">0 kt/year</span> (<span id="china-pct">0%</span>)</div>
                    </div>
                    <div class="sub-item" onclick="flyToCountry('japan')">
                        <div class="sub-item-name">üáØüáµ Japan (<span id="japan-count">0</span>)</div>
                        <div class="sub-item-detail"><span id="japan-capacity">0 kt/year</span> (<span id="japan-pct">0%</span>)</div>
                    </div>
                    <div class="sub-item" onclick="flyToCountry('korea')">
                        <div class="sub-item-name">üá∞üá∑ Korea (<span id="korea-count">0</span>)</div>
                        <div class="sub-item-detail"><span id="korea-capacity">0 kt/year</span> (<span id="korea-pct">0%</span>)</div>
                    </div>
                    <div class="sub-item" onclick="flyToCountry('taiwan')">
                        <div class="sub-item-name">üáπüáº Taiwan (<span id="taiwan-count">0</span>)</div>
                        <div class="sub-item-detail"><span id="taiwan-capacity">0 kt/year</span> (<span id="taiwan-pct">0%</span>)</div>
                    </div>
                    <div class="sub-item" onclick="flyToCountry('sea')">
                        <div class="sub-item-name">üåè SEA (<span id="sea-count">0</span>)</div>
                        <div class="sub-item-detail"><span id="sea-capacity">0 kt/year</span> (<span id="sea-pct">0%</span>)</div>
                    </div>
                </div>
                
                <div class="stat-item" onclick="flyToRegion('americas')">
                    <div style="flex: 1;">
                        <div class="stat-label">
                            <span class="stat-color" style="background-color: #95E1D3;"></span>
                            Americas
                        </div>
                        <div class="stat-detail"><span id="americas-capacity">0 kt/year</span> (<span id="americas-pct">0%</span>)</div>
                    </div>
                    <span class="stat-number" id="americas-count">0</span>
                </div>
                
                <div class="stat-item" onclick="toggleSubItems('europe')">
                    <div style="flex: 1;">
                        <div class="stat-label">
                            <span class="stat-color" style="background-color: #4ECDC4;"></span>
                            Europe
                            <span class="expand-icon" id="europe-icon">‚ñº</span>
                        </div>
                        <div class="stat-detail"><span id="europe-capacity">0 kt/year</span> (<span id="europe-pct">0%</span>)</div>
                    </div>
                    <span class="stat-number" id="europe-count">0</span>
                </div>
                <div class="sub-items" id="europe-sub"></div>
                
                <div class="stat-item" onclick="flyToRegion('middleeast')">
                    <div style="flex: 1;">
                        <div class="stat-label">
                            <span class="stat-color" style="background-color: #FFB84D;"></span>
                            Middle East
                        </div>
                        <div class="stat-detail"><span id="me-capacity">0 kt/year</span> (<span id="me-pct">0%</span>)</div>
                    </div>
                    <span class="stat-number" id="me-count">0</span>
                </div>
                
                <div class="stat-item" onclick="flyToRegion('russia')">
                    <div style="flex: 1;">
                        <div class="stat-label">
                            <span class="stat-color" style="background-color: #C7CEEA;"></span>
                            Russia
                        </div>
                        <div class="stat-detail"><span id="russia-capacity">0 kt/year</span> (<span id="russia-pct">0%</span>)</div>
                    </div>
                    <span class="stat-number" id="russia-count">0</span>
                </div>
            </div>
            
            <div class="legend-section">
                <h3>üìç Status</h3>
                <div class="legend-item" onclick="showMaintenanceMarkers('current')">
                    <div class="legend-marker" style="background-color: black;"></div>
                    <span>Current Maintenance</span>
                </div>
                <div class="legend-item" onclick="showMaintenanceMarkers('future')">
                    <div class="legend-marker" style="background-color: #4169E1; clip-path: polygon(50% 0%, 0% 100%, 100% 100%);"></div>
                    <span>Future Maintenance</span>
                </div>
                
                <div class="size-legend">
                    <h3 style="margin-bottom: 8px;">üìè Capacity</h3>
                    <div class="size-item">
                        <div class="size-circle" style="width: 10px; height: 10px;"></div>
                        <span>0-100 kt</span>
                    </div>
                    <div class="size-item">
                        <div class="size-circle" style="width: 14px; height: 14px;"></div>
                        <span>100-300 kt</span>
                    </div>
                    <div class="size-item">
                        <div class="size-circle" style="width: 18px; height: 18px;"></div>
                        <span>300-500 kt</span>
                    </div>
                    <div class="size-item">
                        <div class="size-circle" style="width: 24px; height: 24px;"></div>
                        <span>500-700 kt</span>
                    </div>
                    <div class="size-item">
                        <div class="size-circle" style="width: 30px; height: 30px;"></div>
                        <span>700+ kt</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let allMarkers = [];
        let clusters = [];
        let currentMaintenanceList = [];
        let futureMaintenanceList = [];
        
        // Capacity Î∞è Loss Í≥ÑÏÇ∞Ïö©
        const monthDays = {
            '1Ïõî': 31, '2Ïõî': 28, '3Ïõî': 31, '4Ïõî': 30, '5Ïõî': 31, '6Ïõî': 30,
            '7Ïõî': 31, '8Ïõî': 31, '9Ïõî': 30, '10Ïõî': 31, '11Ïõî': 30, '12Ïõî': 31
        };
        
        // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        fetch('data.json')
            .then(response => response.json())
            .then(data => {
                clusters = data.clusters;
                initMap();
            })
            .catch(error => {
                console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                alert('ÏßÄÎèÑ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
            });
        
        function initMap() {
            map = L.map('map');
            
            function getRegionColor(country) {
                const regionMap = {
                    'CHINA (MAINLAND)': '#FF6B6B', 'KOREA, SOUTH': '#FF6B6B', 'JAPAN': '#FF6B6B',
                    'TAIWAN': '#FF6B6B', 'SINGAPORE': '#FF6B6B', 'INDONESIA': '#FF6B6B', 'THAILAND': '#FF6B6B',
                    'USA': '#95E1D3', 'CANADA': '#95E1D3', 'BRAZIL': '#95E1D3',
                    'BELGIUM': '#4ECDC4', 'FRANCE': '#4ECDC4', 'GERMANY': '#4ECDC4',
                    'ITALY': '#4ECDC4', 'NETHERLANDS': '#4ECDC4', 'SPAIN': '#4ECDC4',
                    'POLAND': '#4ECDC4', 'CZECH REPUBLIC': '#4ECDC4',
                    'SAUDI ARABIA': '#FFB84D', 'KUWAIT': '#FFB84D', 'IRAN': '#FFB84D',
                    'RUSSIA': '#C7CEEA'
                };
                return regionMap[country] || '#95a5a6';
            }
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap ¬© CARTO'
            }).addTo(map);
            
            let stats = {
                totalCompanies: 0,
                totalCapacity: 0,
                totalLoss: 0,
                currentLoss: 0,
                futureLoss: 0,
                currentMaintCount: 0,
                futureMaintCount: 0,
                regions: {
                    asia: { count: 0, capacity: 0 },
                    americas: { count: 0, capacity: 0 },
                    europe: { count: 0, capacity: 0 },
                    middleeast: { count: 0, capacity: 0 },
                    russia: { count: 0, capacity: 0 }
                },
                countries: {
                    china: { count: 0, capacity: 0 },
                    japan: { count: 0, capacity: 0 },
                    korea: { count: 0, capacity: 0 },
                    taiwan: { count: 0, capacity: 0 },
                    sea: { count: 0, capacity: 0 }
                },
                europeCountries: {}
            };
            
            // ÎßàÏª§ Ï∂îÍ∞Ä Î∞è ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
            clusters.forEach(cluster => {
                cluster.companies.forEach(company => {
                    stats.totalCompanies++;
                    
                    const cap = company.capacity === 'N/A' || !company.capacity ? 0 : parseInt(company.capacity);
                    stats.totalCapacity += cap;
                    
                    const country = company.country;
                    
                    // ÏßÄÏó≠Î≥Ñ ÌÜµÍ≥Ñ
                    if (['CHINA (MAINLAND)', 'KOREA, SOUTH', 'JAPAN', 'TAIWAN', 'SINGAPORE', 'INDONESIA', 'THAILAND'].includes(country)) {
                        stats.regions.asia.count++;
                        stats.regions.asia.capacity += cap;
                        
                        if (country === 'CHINA (MAINLAND)') { stats.countries.china.count++; stats.countries.china.capacity += cap; }
                        else if (country === 'JAPAN') { stats.countries.japan.count++; stats.countries.japan.capacity += cap; }
                        else if (country === 'KOREA, SOUTH') { stats.countries.korea.count++; stats.countries.korea.capacity += cap; }
                        else if (country === 'TAIWAN') { stats.countries.taiwan.count++; stats.countries.taiwan.capacity += cap; }
                        else { stats.countries.sea.count++; stats.countries.sea.capacity += cap; }
                    }
                    else if (['USA', 'CANADA', 'BRAZIL'].includes(country)) {
                        stats.regions.americas.count++;
                        stats.regions.americas.capacity += cap;
                    }
                    else if (['BELGIUM', 'FRANCE', 'GERMANY', 'ITALY', 'NETHERLANDS', 'SPAIN', 'POLAND', 'CZECH REPUBLIC'].includes(country)) {
                        stats.regions.europe.count++;
                        stats.regions.europe.capacity += cap;
                        stats.europeCountries[country] = (stats.europeCountries[country] || 0) + cap;
                    }
                    else if (['SAUDI ARABIA', 'KUWAIT', 'IRAN'].includes(country)) {
                        stats.regions.middleeast.count++;
                        stats.regions.middleeast.capacity += cap;
                    }
                    else if (country === 'RUSSIA') {
                        stats.regions.russia.count++;
                        stats.regions.russia.capacity += cap;
                    }
                    
                    // Ï†ïÍ∏∞Î≥¥Ïàò ÌÜµÍ≥Ñ Î∞è LOSS Í≥ÑÏÇ∞
                    const maintenance = company.maintenance || 'ÏóÜÏùå';
                    if (maintenance !== 'ÏóÜÏùå') {
                        const months = [];
                        for (let m in monthDays) {
                            if (maintenance.includes(m)) months.push(m);
                        }
                        if (months.length > 0) {
                            const totalDays = months.reduce((sum, m) => sum + monthDays[m], 0);
                            const loss = (cap / 365) * totalDays;
                            stats.totalLoss += loss;
                            
                            // Current vs Future Î∂ÑÎ¶¨
                            if (company.is_current_maintenance) {
                                stats.currentLoss += loss;
                            }
                            if (company.has_future_maintenance) {
                                stats.futureLoss += loss;
                            }
                        }
                    }
                    
                    if (company.is_current_maintenance) {
                        stats.currentMaintCount++;
                        currentMaintenanceList.push({
                            company: company.company,
                            location: cluster.location,
                            lat: cluster.lat,
                            lng: cluster.lng,
                            capacity: cap
                        });
                    }
                    if (company.has_future_maintenance) {
                        stats.futureMaintCount++;
                        futureMaintenanceList.push({
                            company: company.company,
                            location: cluster.location,
                            lat: cluster.lat,
                            lng: cluster.lng,
                            capacity: cap,
                            maintenance: company.maintenance
                        });
                    }
                });
                
                // ÎßàÏª§ ÏÉùÏÑ± (Í∏∞Ï°¥ ÏΩîÎìúÏôÄ ÎèôÏùº)
                let color = getRegionColor(cluster.country);
                let shape = 'pin';
                const isCurrentMaintenance = cluster.companies.some(c => c.is_current_maintenance);
                const isFutureMaintenance = cluster.companies.some(c => c.has_future_maintenance);
                
                if (isCurrentMaintenance) color = 'black';
                if (isFutureMaintenance) { shape = 'triangle'; color = '#4169E1'; }
                
                const avgCapacity = cluster.companies.reduce((sum, c) => {
                    const cap = c.capacity === 'N/A' ? 0 : parseInt(c.capacity);
                    return sum + cap;
                }, 0) / cluster.companies.length;
                
                let markerSize = 18;
                if (avgCapacity < 100) markerSize = 10;
                else if (avgCapacity < 300) markerSize = 14;
                else if (avgCapacity < 500) markerSize = 18;
                else if (avgCapacity < 700) markerSize = 24;
                else markerSize = 30;
                
                const pinHeight = markerSize * 1.3;
                let iconHtml = shape === 'triangle'
                    ? `<svg width="${markerSize}" height="${pinHeight}" viewBox="0 0 100 120"><polygon points="50,10 10,110 90,110" fill="${color}" stroke="white" stroke-width="3"/></svg>`
                    : `<svg width="${markerSize}" height="${pinHeight}" viewBox="0 0 100 120"><path d="M50,10 C30,10 15,25 15,45 C15,65 50,110 50,110 C50,110 85,65 85,45 C85,25 70,10 50,10 Z" fill="${color}" stroke="white" stroke-width="3"/></svg>`;
                
                const customIcon = L.divIcon({
                    className: 'custom-marker' + (isFutureMaintenance ? ' pulse-marker' : ''),
                    html: iconHtml,
                    iconSize: [markerSize, pinHeight],
                    iconAnchor: [markerSize/2, pinHeight],
                    popupAnchor: [0, -pinHeight]
                });
                
                const marker = L.marker([cluster.lat, cluster.lng], { icon: customIcon });
                marker.clusterData = cluster;
                marker.isCurrentMaintenance = isCurrentMaintenance;
                marker.isFutureMaintenance = isFutureMaintenance;
                
                let popupContent = `<div style="max-width: 300px;">`;
                if (cluster.companies.length === 1) {
                    const c = cluster.companies[0];
                    popupContent += `<div class="company-name">${c.company}</div>
                        <div><strong>Location:</strong> ${c.location}, ${c.country}</div>
                        <div><strong>Capacity:</strong> ${c.capacity} kt/year</div>
                        <div><strong>Maintenance:</strong> ${c.maintenance}</div>`;
                } else {
                    popupContent += `<div class="company-name">${cluster.location} (${cluster.companies.length} companies)</div>`;
                    cluster.companies.forEach(c => {
                        popupContent += `<div style="border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px;">
                            <div style="font-weight: 500;">${c.company}</div>
                            <div style="font-size: 12px; color: #666;">Capacity: ${c.capacity} kt | Maintenance: ${c.maintenance}</div>
                        </div>`;
                    });
                }
                popupContent += `</div>`;
                marker.bindPopup(popupContent);
                
                let labelMarker;
                marker.on('click', function() {
                    if (labelMarker) map.removeLayer(labelMarker);
                    const labelIcon = L.divIcon({
                        className: 'label-marker',
                        html: cluster.location,
                        iconSize: null,
                        iconAnchor: [0, pinHeight + 10]
                    });
                    labelMarker = L.marker([cluster.lat, cluster.lng], { icon: labelIcon, interactive: false }).addTo(map);
                });
                marker.on('popupclose', function() {
                    if (labelMarker) { map.removeLayer(labelMarker); labelMarker = null; }
                });
                
                marker.addTo(map);
                allMarkers.push(marker);
            });
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('total-count').textContent = stats.totalCompanies;
            document.getElementById('total-capacity').textContent = stats.totalCapacity.toLocaleString();
            
            // Current Loss Rate
            const currentLossRate = (stats.currentLoss / stats.totalCapacity * 100).toFixed(2);
            document.getElementById('current-loss-rate').textContent = currentLossRate;
            document.getElementById('current-loss-detail').textContent = `Loss: ${Math.round(stats.currentLoss).toLocaleString()} kt`;
            
            // Total Loss Rate (2026)
            const totalLossRate = (stats.totalLoss / stats.totalCapacity * 100).toFixed(2);
            document.getElementById('total-loss-rate').textContent = totalLossRate;
            document.getElementById('total-loss-detail').textContent = `Loss: ${Math.round(stats.totalLoss).toLocaleString()} kt`;
            
            document.getElementById('current-maintenance-count').textContent = stats.currentMaintCount;
            document.getElementById('future-maintenance-count').textContent = stats.futureMaintCount;
            
            // ÏßÄÏó≠Î≥Ñ
            document.getElementById('asia-count').textContent = stats.regions.asia.count;
            document.getElementById('asia-capacity').textContent = `${stats.regions.asia.capacity.toLocaleString()} kt/year`;
            document.getElementById('asia-pct').textContent = `${(stats.regions.asia.capacity / stats.totalCapacity * 100).toFixed(1)}%`;
            
            document.getElementById('americas-count').textContent = stats.regions.americas.count;
            document.getElementById('americas-capacity').textContent = `${stats.regions.americas.capacity.toLocaleString()} kt/year`;
            document.getElementById('americas-pct').textContent = `${(stats.regions.americas.capacity / stats.totalCapacity * 100).toFixed(1)}%`;
            
            document.getElementById('europe-count').textContent = stats.regions.europe.count;
            document.getElementById('europe-capacity').textContent = `${stats.regions.europe.capacity.toLocaleString()} kt/year`;
            document.getElementById('europe-pct').textContent = `${(stats.regions.europe.capacity / stats.totalCapacity * 100).toFixed(1)}%`;
            
            document.getElementById('me-count').textContent = stats.regions.middleeast.count;
            document.getElementById('me-capacity').textContent = `${stats.regions.middleeast.capacity.toLocaleString()} kt/year`;
            document.getElementById('me-pct').textContent = `${(stats.regions.middleeast.capacity / stats.totalCapacity * 100).toFixed(1)}%`;
            
            document.getElementById('russia-count').textContent = stats.regions.russia.count;
            document.getElementById('russia-capacity').textContent = `${stats.regions.russia.capacity.toLocaleString()} kt/year`;
            document.getElementById('russia-pct').textContent = `${(stats.regions.russia.capacity / stats.totalCapacity * 100).toFixed(1)}%`;
            
            // ÏïÑÏãúÏïÑ Íµ≠Í∞ÄÎ≥Ñ
            document.getElementById('china-count').textContent = stats.countries.china.count;
            document.getElementById('china-capacity').textContent = `${stats.countries.china.capacity.toLocaleString()} kt/year`;
            document.getElementById('china-pct').textContent = `${(stats.countries.china.capacity / stats.totalCapacity * 100).toFixed(1)}%`;
            
            document.getElementById('japan-count').textContent = stats.countries.japan.count;
            document.getElementById('japan-capacity').textContent = `${stats.countries.japan.capacity.toLocaleString()} kt/year`;
            document.getElementById('japan-pct').textContent = `${(stats.countries.japan.capacity / stats.totalCapacity * 100).toFixed(1)}%`;
            
            document.getElementById('korea-count').textContent = stats.countries.korea.count;
            document.getElementById('korea-capacity').textContent = `${stats.countries.korea.capacity.toLocaleString()} kt/year`;
            document.getElementById('korea-pct').textContent = `${(stats.countries.korea.capacity / stats.totalCapacity * 100).toFixed(1)}%`;
            
            document.getElementById('taiwan-count').textContent = stats.countries.taiwan.count;
            document.getElementById('taiwan-capacity').textContent = `${stats.countries.taiwan.capacity.toLocaleString()} kt/year`;
            document.getElementById('taiwan-pct').textContent = `${(stats.countries.taiwan.capacity / stats.totalCapacity * 100).toFixed(1)}%`;
            
            document.getElementById('sea-count').textContent = stats.countries.sea.count;
            document.getElementById('sea-capacity').textContent = `${stats.countries.sea.capacity.toLocaleString()} kt/year`;
            document.getElementById('sea-pct').textContent = `${(stats.countries.sea.capacity / stats.totalCapacity * 100).toFixed(1)}%`;
            
            // Ïú†ÎüΩ Íµ≠Í∞ÄÎ≥Ñ Î¶¨Ïä§Ìä∏ ÏÉùÏÑ±
            const europeSubDiv = document.getElementById('europe-sub');
            const europeCountries = [
                { code: 'GERMANY', name: 'üá©üá™ Germany', lat: 51, lng: 10, zoom: 6 },
                { code: 'BELGIUM', name: 'üáßüá™ Belgium', lat: 50.8, lng: 4.3, zoom: 8 },
                { code: 'FRANCE', name: 'üá´üá∑ France', lat: 49.5, lng: 0.2, zoom: 7 },
                { code: 'SPAIN', name: 'üá™üá∏ Spain', lat: 41.1, lng: 1.2, zoom: 7 },
                { code: 'NETHERLANDS', name: 'üá≥üá± Netherlands', lat: 51.7, lng: 4.6, zoom: 8 },
                { code: 'ITALY', name: 'üáÆüáπ Italy', lat: 45.2, lng: 10.8, zoom: 8 },
                { code: 'CZECH REPUBLIC', name: 'üá®üáø Czech Rep.', lat: 50.2, lng: 14.3, zoom: 8 },
                { code: 'POLAND', name: 'üáµüá± Poland', lat: 50.0, lng: 19.2, zoom: 8 }
            ];
            
            europeCountries.forEach(ec => {
                const cap = stats.europeCountries[ec.code] || 0;
                if (cap > 0) {
                    const pct = (cap / stats.totalCapacity * 100).toFixed(1);
                    const div = document.createElement('div');
                    div.className = 'sub-item';
                    div.onclick = () => map.flyTo([ec.lat, ec.lng], ec.zoom, { duration: 1.5 });
                    div.innerHTML = `
                        <div class="sub-item-name">${ec.name}</div>
                        <div class="sub-item-detail">${cap.toLocaleString()} kt/year (${pct}%)</div>
                    `;
                    europeSubDiv.appendChild(div);
                }
            });
            
            // Ï†ïÍ∏∞Î≥¥Ïàò Î¶¨Ïä§Ìä∏
            const currentSubDiv = document.getElementById('current-sub');
            currentMaintenanceList.forEach(item => {
                const div = document.createElement('div');
                div.className = 'sub-item';
                div.onclick = () => flyToCompany(item.lat, item.lng);
                div.innerHTML = `
                    <div class="sub-item-name">‚ö´ ${item.company.substring(0, 28)}...</div>
                    <div class="sub-item-detail">${item.location} | ${item.capacity} kt</div>
                `;
                currentSubDiv.appendChild(div);
            });
            
            const futureSubDiv = document.getElementById('future-sub');
            futureMaintenanceList.forEach(item => {
                const div = document.createElement('div');
                div.className = 'sub-item';
                div.onclick = () => flyToCompany(item.lat, item.lng);
                div.innerHTML = `
                    <div class="sub-item-name">üîµ ${item.company.substring(0, 28)}...</div>
                    <div class="sub-item-detail">${item.location} | ${item.maintenance}</div>
                `;
                futureSubDiv.appendChild(div);
            });
            
            // Fit Bounds
            const bounds = L.latLngBounds(clusters.map(c => [c.lat, c.lng]));
            map.fitBounds(bounds, { padding: [50, 50] });
        }
        
        function toggleSubItems(type) {
            const subDiv = document.getElementById(type + '-sub');
            const icon = document.getElementById(type + '-icon');
            if (subDiv && icon) {
                subDiv.classList.toggle('active');
                icon.classList.toggle('expanded');
            } else {
                flyToRegion(type);
            }
        }
        
        function flyToRegion(region) {
            const centers = {
                'americas': { lat: 40, lng: -95, zoom: 3 },
                'middleeast': { lat: 27, lng: 50, zoom: 5 },
                'russia': { lat: 56, lng: 54, zoom: 5 }
            };
            const c = centers[region];
            if (c) map.flyTo([c.lat, c.lng], c.zoom, { duration: 1.5 });
        }
        
        function flyToCountry(country) {
            const centers = {
                'china': { lat: 35, lng: 115, zoom: 5 },
                'japan': { lat: 36, lng: 138, zoom: 6 },
                'korea': { lat: 36.5, lng: 127.5, zoom: 7 },
                'taiwan': { lat: 24, lng: 121, zoom: 8 },
                'sea': { lat: 5, lng: 110, zoom: 5 }
            };
            const c = centers[country];
            if (c) map.flyTo([c.lat, c.lng], c.zoom, { duration: 1.5 });
        }
        
        function flyToCompany(lat, lng) {
            map.flyTo([lat, lng], 7, { duration: 1.5 });
            setTimeout(() => {
                allMarkers.forEach(m => {
                    const pos = m.getLatLng();
                    if (Math.abs(pos.lat - lat) < 0.01 && Math.abs(pos.lng - lng) < 0.01) {
                        m.openPopup();
                    }
                });
            }, 1600);
        }
        
        function showMaintenanceMarkers(type) {
            const targetMarkers = allMarkers.filter(m => 
                type === 'current' ? m.isCurrentMaintenance : m.isFutureMaintenance
            );
            if (targetMarkers.length > 0) {
                const bounds = L.latLngBounds(targetMarkers.map(m => m.getLatLng()));
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 6 });
            }
        }
        
        function resetMapView() {
            const bounds = L.latLngBounds(clusters.map(c => [c.lat, c.lng]));
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    </script>
</body>
</html>
