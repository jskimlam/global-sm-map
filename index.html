<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global SM Companies Status</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; overflow: hidden; }
        .container { display: flex; height: 100vh; width: 100vw; position: relative; overflow: hidden; }

        /* ÏßÄÎèÑ ÏòÅÏó≠ */
        .map-section { flex: 1; height: 100%; position: relative; transition: all 0.4s ease; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* ÏÇ¨Ïù¥ÎìúÎ∞î (Ïò§Î•∏Ï™Ω Î∞∞Ïπò) */
        .sidebar { 
            width: 400px; height: 100%; background: white; 
            box-shadow: -5px 0 15px rgba(0,0,0,0.1); 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000; position: relative; overflow-y: auto;
        }
        .container.collapsed .sidebar { transform: translateX(400px); width: 0; }

        /* Ïä¨ÎùºÏù¥Îìú Ìï∏Îì§ Î≤ÑÌäº (ÏÇ¨Ïù¥ÎìúÎ∞î ÏôºÏ™ΩÏóê ÌôïÏã§Ìûà Î∂ÄÏ∞©) */
        #toggle-btn {
            position: absolute; left: -30px; top: 50%; transform: translateY(-50%);
            width: 30px; height: 80px; background: #4b6cb7; color: white;
            border: none; border-radius: 12px 0 0 12px; cursor: pointer;
            z-index: 1100; font-size: 18px; display: flex; align-items: center; justify-content: center;
            box-shadow: -3px 0 10px rgba(0,0,0,0.2);
        }

        /* Ìó§Îçî Î∏åÎûúÎî© */
        #header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 20px; }
        #header h1 { font-size: 19px; font-weight: 600; margin-bottom: 2px; }
        .made-by { font-size: 12px; font-weight: bold; color: #ffeb3b; margin-bottom: 12px; }
        .archive-select {
            width: 100%; padding: 10px; border-radius: 6px; border: none;
            background: rgba(255,255,255,0.2); color: white; font-weight: bold; cursor: pointer;
        }

        /* ÌÜµÍ≥Ñ ÏÑπÏÖò */
        .stats-section { padding: 15px 20px; border-bottom: 1px solid #eee; }
        .stats-section h3 { font-size: 12px; color: #2a5298; margin-bottom: 12px; text-transform: uppercase; font-weight: 700; }
        
        .cap-card { padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid #2a5298; background: #f8faff; }
        .cap-val { font-size: 24px; font-weight: 800; color: #333; }
        .cap-denom { font-size: 11px; color: #666; margin-top: 5px; border-top: 1px dashed #ccc; padding-top: 5px; }

        /* ÏßÄÏó≠ Î¶¨Ïä§Ìä∏ */
        .reg-box { margin-bottom: 5px; border: 1px solid #eee; border-radius: 6px; }
        .reg-head { padding: 8px 12px; background: #fcfcfc; display: flex; justify-content: space-between; cursor: pointer; font-size: 13px; font-weight: 600; }
        .reg-body { background: #fff; display: none; }
        .reg-box.open .reg-body { display: block; }
        .cty-item { padding: 6px 25px; font-size: 12px; cursor: pointer; display: flex; justify-content: space-between; border-top: 1px solid #f9f9f9; }
        .cty-item:hover { background: #f0f4ff; color: #2a5298; }

        /* ÏµúÏ¥àÏùò Î¨ºÎ∞©Ïö∏(Pin) ÎßàÏª§ Ïä§ÌÉÄÏùº */
        .pin-marker { filter: drop-shadow(0 3px 4px rgba(0,0,0,0.4)); }
        
        .maint-list-item { padding: 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 5px; font-size: 11px; cursor: pointer; }
        .maint-list-item:hover { border-color: #2a5298; background: #f4f7ff; }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <div class="map-section">
            <div id="map"></div>
        </div>
        
        <div class="sidebar" id="sidebar">
            <button id="toggle-btn" onclick="toggleSidebar()">‚óÄ</button>

            <div id="header">
                <h1>Global SM Companies Status</h1>
                <div class="made-by">Made by LAM</div>
                <select class="archive-select" onchange="switchProduct(this.value)">
                    <option value="data.json">Styrene Monomer (SM)</option>
                    <option value="data_an.json">AN (Acrylonitrile) - Ï§ÄÎπÑÏ§ë</option>
                    <option value="data_bd.json">Butadiene (BD) - Ï§ÄÎπÑÏ§ë</option>
                </select>
            </div>

            <div class="stats-section">
                <h3>üìä Market Balance (2026)</h3>
                <div class="cap-card" style="border-color: #4a90e2;">
                    <div style="font-size:11px; font-weight:bold; color:#4a90e2;">Yearly Cumulative Loss</div>
                    <span class="cap-val" id="yr-rate">0.00%</span>
                    <div class="cap-denom" id="yr-denom">Loss: 0 / Total: 0 kt</div>
                </div>
                <div class="cap-card" style="border-color: #e74c3c; background: #fff5f5;">
                    <div style="font-size:11px; font-weight:bold; color:#e74c3c;">Current Loss (Feb)</div>
                    <span class="cap-val" id="cur-rate" style="color:#e74c3c;">0.00%</span>
                    <div class="cap-denom" id="cur-denom">Loss: 0 / Base: 0 kt</div>
                </div>
            </div>

            <div class="stats-section">
                <h3>üåç Regional Weight</h3>
                <div id="region-tree"></div>
            </div>

            <div class="stats-section">
                <h3>üìç Maintenance List (Feb)</h3>
                <div id="maint-list"></div>
            </div>
        </div>
    </div>

    <script>
        let map, clusters = [], allMarkers = [];
        const today = new Date('2026-02-04');
        const febStart = new Date('2026-02-01'), febEnd = new Date('2026-02-28');

        function init() {
            map = L.map('map').setView([25, 115], 3);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            loadData('data.json');
        }

        async function loadData(file) {
            try {
                const res = await fetch(file);
                const data = await res.json();
                clusters = data.clusters;
                updateAll();
            } catch(e) { console.error("Data Load Failed"); }
        }

        function updateAll() {
            allMarkers.forEach(m => map.removeLayer(m));
            allMarkers = [];

            let totalCap = 0, curLoss = 0, yrLoss = 0;
            let regData = { 'Asia': { cap: 0, cty: {'CHINA (MAINLAND)':0, 'KOREA, SOUTH':0, 'JAPAN':0, 'TAIWAN':0, 'SEA':0} }, 'Americas':{cap:0}, 'Europe':{cap:0}, 'ME/Other':{cap:0} };

            const listDiv = document.getElementById('maint-list');
            listDiv.innerHTML = '';

            clusters.forEach(c => {
                let clusterCap = 0, isCurrent = false, isFuture = false;

                c.companies.forEach(comp => {
                    const cap = parseFloat(comp.capacity) || 0;
                    totalCap += cap;
                    clusterCap += cap;

                    // ÏßÄÏó≠ Î∂ÑÎ•ò
                    let r = ['USA','CANADA','BRAZIL'].includes(c.country) ? 'Americas' : ['BELGIUM','FRANCE','GERMANY','NETHERLANDS','SPAIN','ITALY'].includes(c.country) ? 'Europe' : ['SAUDI ARABIA','KUWAIT','IRAN','RUSSIA'].includes(c.country) ? 'ME/Other' : 'Asia';
                    regData[r].cap += cap;
                    if(r === 'Asia') {
                        if(regData.Asia.cty[c.country] !== undefined) regData.Asia.cty[c.country] += cap;
                        else regData.Asia.cty['SEA'] += cap;
                    }

                    // ÎÇ†Ïßú Î°úÏßÅ
                    if (comp.maint_start && comp.maint_end) {
                        const s = new Date(comp.maint_start), e = new Date(comp.maint_end);
                        const yrLap = Math.max(0, Math.min(e, new Date('2026-12-31')) - Math.max(s, new Date('2026-01-01'))) / 86400000 + 1;
                        yrLoss += (cap / 365) * yrLap;

                        const febLap = Math.max(0, Math.min(e, febEnd) - Math.max(s, febStart)) / 86400000 + 1;
                        if(febLap > 0) {
                            curLoss += (cap / 365) * febLap;
                            isCurrent = (today >= s && today <= e);
                            if(isCurrent) listDiv.innerHTML += `<div class="maint-list-item" onclick="map.flyTo([${c.lat},${c.lng}],8)"><b>${comp.company}</b><br>Loss: ${Math.round((cap/365)*febLap)}kt</div>`;
                        }
                        if(s > today) isFuture = true;
                        if(today >= s && today <= e) isCurrent = true;
                    }
                });

                // ÏµúÏ¥àÏùò Î¨ºÎ∞©Ïö∏(Pin) ÎîîÏûêÏù∏ Î≥µÍµ¨
                let size = clusterCap < 100 ? 20 : clusterCap < 400 ? 30 : clusterCap < 700 ? 40 : 55;
                const color = isCurrent ? "#000000" : (isFuture ? "#e67e22" : "#2a5298");
                
                const icon = L.divIcon({
                    className: 'pin-marker',
                    html: isFuture ? 
                        `<svg width="${size}" height="${size}" viewBox="0 0 100 100"><path d="M50 5 L90 85 L10 85 Z" fill="${color}" stroke="white" stroke-width="4"/></svg>` :
                        `<svg width="${size}" height="${size}" viewBox="0 0 100 120"><path d="M50 0 C22 0 0 22 0 50 C0 85 50 120 50 120 C50 120 100 85 100 50 C100 22 78 0 50 0 Z" fill="${color}" stroke="white" stroke-width="5"/><circle cx="50" cy="50" r="15" fill="white" opacity="0.3"/></svg>`,
                    iconSize: [size, size], iconAnchor: [size/2, size]
                });

                const m = L.marker([c.lat, c.lng], {icon}).addTo(map);
                m.bindPopup(`<b>${c.location}</b><br>Capacity: ${clusterCap}kt`);
                allMarkers.push(m);
            });

            // ÏàòÏπò ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('yr-rate').innerText = (yrLoss / totalCap * 100).toFixed(2) + "%";
            document.getElementById('yr-denom').innerText = `Loss: ${Math.round(yrLoss).toLocaleString()} / Total: ${Math.round(totalCap).toLocaleString()} kt`;
            document.getElementById('cur-rate').innerText = (curLoss / (totalCap/12) * 100).toFixed(2) + "%";
            document.getElementById('cur-denom').innerText = `Loss: ${Math.round(curLoss).toLocaleString()} / Base: ${Math.round(totalCap/12).toLocaleString()} kt`;

            // ÏßÄÏó≠ Ìä∏Î¶¨ ÏÉùÏÑ±
            const tree = document.getElementById('region-tree');
            tree.innerHTML = '';
            Object.keys(regData).forEach(r => {
                const p = (regData[r].cap / totalCap * 100).toFixed(1);
                let h = `<div class="reg-box"><div class="reg-head" onclick="this.parentElement.classList.toggle('open'); flyTo('${r.toLowerCase()}')"><span>${r}</span><span>${p}%</span></div><div class="reg-body">`;
                if(r === 'Asia') {
                    Object.keys(regData.Asia.cty).forEach(ct => {
                        const cp = (regData.Asia.cty[ct] / totalCap * 100).toFixed(1);
                        h += `<div class="cty-item" onclick="flyTo('${ct.toLowerCase().replace(' (mainland)','').replace(', south','')}')"><span>${ct}</span><span>${cp}%</span></div>`;
                    });
                }
                h += `</div></div>`;
                tree.innerHTML += h;
            });
        }

        function toggleSidebar() {
            const c = document.getElementById('main-container');
            c.classList.toggle('collapsed');
            document.getElementById('toggle-btn').innerText = c.classList.contains('collapsed') ? '‚óÄ' : '‚ñ∂';
            setTimeout(() => map.invalidateSize(), 400);
        }

        function flyTo(l) {
            const t = { 'asia':[[20, 110],4], 'korea':[[36.5, 127],7], 'china':[[35, 110],5], 'japan':[[36, 138],6], 'taiwan':[[23.5, 121],7], 'americas':[[38,-98],4], 'europe':[[50, 10],4] };
            if(t[l]) map.flyTo(t[l][0], t[l][1]);
        }
        function switchProduct(v) { loadData(v); }
        window.onload = init;
    </script>
</body>
</html>
