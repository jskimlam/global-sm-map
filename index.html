<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global SM Companies Status</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; overflow: hidden; }
        .container { display: flex; height: 100vh; width: 100vw; position: relative; }

        /* ì§€ë„ ì˜ì—­ */
        .map-section { flex: 1; height: 100%; position: relative; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* ì‚¬ì´ë“œë°” (ìµœì´ˆ ë””ìì¸ ë³µêµ¬) */
        .sidebar { 
            width: 380px; height: 100%; background: white; 
            box-shadow: -3px 0 15px rgba(0,0,0,0.1); 
            transition: transform 0.4s ease;
            z-index: 1000; position: relative; overflow-y: auto;
        }
        .container.sidebar-hidden .sidebar { transform: translateX(380px); width: 0; }

        /* ìŠ¬ë¼ì´ë“œ ë²„íŠ¼ (ì§€ë„ ìš°ì¸¡ ìƒë‹¨ ê³ ì •) */
        #toggle-btn {
            position: absolute; right: 20px; top: 20px;
            width: 50px; height: 50px; background: #4b6cb7; color: white;
            border: none; border-radius: 12px; cursor: pointer;
            z-index: 1100; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* í—¤ë” ë° Made by LAM */
        #header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 20px; }
        #header h1 { font-size: 20px; margin-bottom: 2px; }
        .made-by { font-size: 12px; font-weight: bold; color: #ffeb3b; margin-bottom: 12px; }
        
        .archive-select {
            width: 100%; padding: 10px; border-radius: 6px; border: none;
            background: rgba(255,255,255,0.2); color: white; font-weight: bold; cursor: pointer;
        }

        /* í†µê³„ ì„¹ì…˜ */
        .stats-section { padding: 20px; border-bottom: 1px solid #eee; }
        .stats-section h3 { font-size: 13px; color: #2a5298; margin-bottom: 12px; text-transform: uppercase; font-weight: 700; }
        
        .cap-card { padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid #2a5298; background: #f8faff; }
        .cap-val { font-size: 22px; font-weight: 800; color: #333; }
        .cap-label { font-size: 11px; color: #666; margin-bottom: 5px; font-weight: bold; }

        /* ë‚´ë¹„ê²Œì´ì…˜ */
        .nav-group { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .nav-btn { padding: 7px 12px; font-size: 11px; background: #f0f2f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }

        /* ë¬¼ë°©ìš¸(Pin) ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
        .pin-marker { filter: drop-shadow(0 3px 4px rgba(0,0,0,0.3)); }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <div class="map-section">
            <div id="map"></div>
            <button id="toggle-btn" onclick="toggleSidebar()">â˜°</button>
        </div>
        
        <div class="sidebar" id="sidebar">
            <div id="header">
                <h1>Global SM Companies Status</h1>
                <div class="made-by">Made by LAM</div>
                <select class="archive-select" onchange="switchProduct(this.value)">
                    <option value="data.json">Styrene Monomer (SM)</option>
                    <option value="data_an.json">AN (Acrylonitrile) - ì¤€ë¹„ì¤‘</option>
                    <option value="data_bd.json">Butadiene (BD) - ì¤€ë¹„ì¤‘</option>
                </select>
            </div>

            <div class="stats-section">
                <h3>ğŸ“Š Market Balance</h3>
                <div class="cap-card">
                    <div class="cap-label">Total Capacity</div>
                    <span class="cap-val" id="total-cap">0</span> <small>kt/y</small>
                </div>
                <div class="cap-card" style="border-color: #ff6b6b; background: #fff5f5;">
                    <div class="cap-label" style="color: #ff6b6b;">Current Loss Rate (Feb)</div>
                    <span class="cap-val" id="loss-rate" style="color: #ff6b6b;">0.00%</span>
                    <div style="font-size: 11px; color: #666; margin-top: 5px;" id="loss-kt">Loss: 0 kt</div>
                </div>
            </div>

            <div class="stats-section">
                <h3>ğŸŒ Navigation</h3>
                <div class="nav-group">
                    <button class="nav-btn" onclick="flyTo('korea')">ğŸ‡°ğŸ‡· Korea</button>
                    <button class="nav-btn" onclick="flyTo('china')">ğŸ‡¨ğŸ‡³ China</button>
                    <button class="nav-btn" onclick="flyTo('japan')">ğŸ‡¯ğŸ‡µ Japan</button>
                    <button class="nav-btn" onclick="flyTo('taiwan')">ğŸ‡¹ğŸ‡¼ Taiwan</button>
                    <button class="nav-btn" onclick="flyTo('europe')">ğŸ‡ªğŸ‡º Europe</button>
                    <button class="nav-btn" onclick="flyTo('usa')">ğŸ‡ºğŸ‡¸ USA</button>
                </div>
            </div>

            <div class="stats-section">
                <h3>ğŸ“ Company List</h3>
                <div id="maint-list" style="font-size: 12px; color: #666;"></div>
            </div>
        </div>
    </div>

    <script>
        let map, clusters = [], allMarkers = [];

        function initApp() {
            map = L.map('map').setView([25, 115], 3);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            loadData('data.json');
        }

        async function loadData(file) {
            try {
                const res = await fetch(file);
                const data = await res.json();
                clusters = data.clusters;
                renderMap();
            } catch(e) { console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"); }
        }

        function renderMap() {
            allMarkers.forEach(m => map.removeLayer(m));
            allMarkers = [];
            
            let totalGlobalCap = 0, currentLoss = 0;
            const listDiv = document.getElementById('maint-list');
            listDiv.innerHTML = '';

            clusters.forEach(c => {
                let clusterCap = 0, isMaint = false;

                c.companies.forEach(comp => {
                    const cap = parseFloat(comp.capacity) || 0;
                    totalGlobalCap += cap;
                    clusterCap += cap;
                    // 2ì›” ì •ê¸°ë³´ìˆ˜ ì²´í¬ (ê¸°ì¡´ ë°©ì‹ ë³µêµ¬)
                    if (comp.maintenance && (comp.maintenance.includes('2ì›”') || comp.is_current_maintenance)) {
                        isMaint = true;
                        currentLoss += (cap / 365) * 28;
                        listDiv.innerHTML += `â€¢ ${comp.company} (${comp.capacity}kt)<br>`;
                    }
                });

                // ìµœì´ˆì˜ ë¬¼ë°©ìš¸(Pin) ë§ˆì»¤ ë””ìì¸
                let size = clusterCap < 100 ? 25 : clusterCap < 400 ? 35 : 45;
                const color = isMaint ? "#000000" : "#2a5298";
                
                const pinIcon = L.divIcon({
                    className: 'pin-marker',
                    html: `<svg width="${size}" height="${size}" viewBox="0 0 100 120"><path d="M50 0 C22 0 0 22 0 50 C0 85 50 120 50 120 C50 120 100 85 100 50 C100 22 78 0 50 0 Z" fill="${color}" stroke="white" stroke-width="5"/></svg>`,
                    iconSize: [size, size], iconAnchor: [size/2, size]
                });

                const m = L.marker([c.lat, c.lng], {icon: pinIcon}).addTo(map);
                m.bindPopup(`<b>${c.location}</b><br>Capacity: ${clusterCap}kt`);
                allMarkers.push(m);
            });

            // í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('total-cap').innerText = Math.round(totalGlobalCap).toLocaleString();
            document.getElementById('loss-rate').innerText = (currentLoss / (totalGlobalCap/12) * 100).toFixed(2) + "%";
            document.getElementById('loss-kt').innerText = `Loss: ${Math.round(currentLoss).toLocaleString()} kt`;
        }

        function toggleSidebar() {
            const container = document.getElementById('main-container');
            container.classList.toggle('sidebar-hidden');
            setTimeout(() => map.invalidateSize(), 400);
        }

        function flyTo(loc) {
            const targets = { 'korea':[[36.5, 127], 7], 'china':[[35, 110], 5], 'japan':[[36, 138], 6], 'taiwan':[[23.5, 121], 7], 'europe':[[50, 10], 4], 'usa':[[38, -98], 4] };
            map.flyTo(targets[loc][0], targets[loc][1]);
        }

        function switchProduct(val) { loadData(val); }

        window.onload = initApp;
    </script>
</body>
</html>
